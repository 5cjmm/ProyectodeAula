<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ShopMaster - Predicción de Precios</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif
        }

        .card {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            border-radius: 12px;
            padding: 22px;
            box-shadow: 0 1px 8px rgba(0, 0, 0, .06)
        }
    </style>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const tiendaId = /*[[${tiendaId}]]*/ 'defaultTienda';
        /*]]>*/
    </script>
</head>

<body class="bg-gray-50">

    <div class="flex min-h-screen">
        <!-- Sidebar (copiada y reducida del layout existente) -->
        <aside class="w-64 bg-white border-r border-gray-200 p-6">
            <div class="flex flex-col items-center mb-10">
                <div class="p-4 rounded-xl shadow-sm border border-gray-100">
                    <img th:src="@{/images/logo.png}" alt="ShopMaster" class="h-24 w-auto object-contain">
                </div>
            </div>

            <input type="hidden" id="tiendaId" th:value="${tiendaId}">

            <nav class="space-y-2">
                <a id="linkDashboard"
                    class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" />
                    </svg>
                    Dashboard
                </a>
                <a id="linkInventario"
                    class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                    Inventario
                </a>
                <a id="linkProveedores"
                    class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3z" />
                    </svg>
                    Proveedores
                </a>
                <a id="linkDeudas" class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                    </svg>
                    Deudas
                </a>
                <a id="linkPuntoVenta"
                    class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                    </svg>
                    Punto de Venta
                </a>
                <a id="linkInforme" class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                    </svg>
                    Informe de Ventas
                </a>
                <a id="linkPrediccion" class="flex items-center gap-3 px-3 py-2 bg-cyan-50 text-cyan-700 rounded-lg">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 3h14v2H3V3zm0 4h10v2H3V7zm0 4h6v2H3v-2z" />
                    </svg>
                    Predicción
                </a>
                <a id="linkTendero" class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                    </svg>
                    Gestion de Tenderos
                </a>
                <a id="linkTiendas" class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" />
                    </svg>
                    Tiendas
                </a>
                <a href="/logout" class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" />
                    </svg>
                    Cerrar sesión
                </a>
            </nav>
        </aside>

        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200 shadow-sm">
                <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                    <h1 class="text-xl font-semibold text-gray-800">Predicción de Precios</h1>
                    <div class="flex items-center gap-3">
                        <img src="/admin-avatar.png" alt="Admin" class="w-9 h-9 rounded-full border-2 border-gray-300">
                        <span class="text-sm font-medium text-gray-700">Administrador</span>
                    </div>
                </div>
            </header>

            <main class="w-full max-w-none px-8 py-8">
                <div class="max-w-[1200px] mx-auto">

                    <div class="card">
                        <h2 class="text-lg font-semibold mb-4">Predict Price</h2>

                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">Select Product:</label>
                                <select id="productSelect" class="w-full px-3 py-2 border rounded-md">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">Timeframe:</label>
                                <select id="horizon" class="w-full px-3 py-2 border rounded-md">
                                    <option value="3">3 months</option>
                                    <option value="6" selected>6 months</option>
                                    <option value="8">8 months</option>
                                    <option value="12">12 months</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="text-sm font-medium text-gray-700 mb-2">Price Prediction</div>
                            <div style="height:320px">
                                <canvas id="predictionChart"></canvas>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-3 gap-3 mb-3">
                            <div class="p-3 border rounded bg-gray-50">
                                <div class="text-xs text-gray-500">Current price</div>
                                <div id="currentPrice" class="font-semibold">-</div>
                            </div>
                            <div class="p-3 border rounded bg-gray-50">
                                <div class="text-xs text-gray-500">Prediction in <span id="horizonLabel">6</span> months
                                </div>
                                <div id="predictedPrice" class="font-semibold">-</div>
                            </div>
                            <div class="p-3 border rounded bg-gray-50">
                                <div class="text-xs text-gray-500">Expected variation</div>
                                <div id="expectedVar" class="font-semibold">-</div>
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button id="btnGeneratePDF" class="px-4 py-2 border rounded">Generate PDF Report</button>
                            <button id="btnSaveHistory" class="px-4 py-2 bg-cyan-600 text-white rounded">Save to
                                History</button>
                        </div>

                    </div>

                </div>
            </main>
        </div>
    </div>

    <script>
        (function () {
            // DOM refs
            const tiendaIdEl = document.getElementById('tiendaId');
            const tienda = tiendaIdEl ? tiendaIdEl.value : (typeof tiendaId !== 'undefined' ? tiendaId : null);

            let currentPredictionData = null;

            async function loadProducts() {
                try {
                    if (!tienda) throw new Error('tiendaId no definido');
                    const resp = await fetch(`/api//tienda/${tienda}?page=0&size=50`);
                    if (!resp.ok) throw new Error('No se pudieron cargar productos');
                    const page = await resp.json();
                    const list = page.content || page;
                    const sel = document.getElementById('productSelect');
                    sel.innerHTML = '';
                    (list || []).forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = p.nombre;
                        sel.appendChild(opt);
                    });
                    if (list && list.length > 0) setTimeout(() => fetchAndRenderPrediction(), 300);
                } catch (e) {
                    console.error(e);
                    const sel = document.getElementById('productSelect');
                    sel.innerHTML = '<option value="">No products</option>';
                }
            }

            async function fetchPrediction(productId, horizonMonths) {
                const resp = await fetch('/api/predictions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, tiendaId: tienda, horizonMonths, granularity: 'monthly' })
                });
                if (!resp.ok) throw new Error('Error en la predicción');
                return resp.json();
            }

            function renderChart(historical, forecast) {
                const histDates = historical.map(h => h.date);
                const histVals = historical.map(h => h.value);
                const foreDates = forecast.map(f => f.date);
                const foreVals = forecast.map(f => f.value);

                const labels = histDates.concat(foreDates);
                const histData = histVals.concat(new Array(foreVals.length).fill(null));
                const forecastData = new Array(histVals.length).fill(null).concat(foreVals);

                const ctx = document.getElementById('predictionChart').getContext('2d');
                if (window.predChart) window.predChart.destroy();

                window.predChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            { label: 'Current price', data: histData, borderColor: '#2196F3', backgroundColor: 'transparent', borderWidth: 2, pointRadius: 3, tension: 0.3 },
                            { label: 'Prediction', data: forecastData, borderColor: '#00C853', backgroundColor: 'transparent', borderWidth: 2, borderDash: [6, 4], pointRadius: 3, tension: 0.3 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, interaction: { intersect: false, mode: 'index' }, scales: { y: { grid: { color: '#f3f3f3' } } }
                    }
                });
            }

            async function fetchAndRenderPrediction() {
                const productId = document.getElementById('productSelect').value;
                const horizon = Number(document.getElementById('horizon').value);
                if (!productId) return;
                document.getElementById('horizonLabel').textContent = horizon;
                try {
                    const data = await fetchPrediction(productId, horizon);
                    currentPredictionData = data;
                    renderChart(data.historical || [], data.forecast || []);
                    const formatCurrency = (val) => { if (val === null || val === undefined) return '-'; return '$' + Number(val).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); };
                    document.getElementById('currentPrice').textContent = formatCurrency(data.currentPrice);
                    if (data.forecast && data.forecast.length > 0) document.getElementById('predictedPrice').textContent = formatCurrency(data.forecast[data.forecast.length - 1].value);
                    else document.getElementById('predictedPrice').textContent = '-';
                    if (data.expectedVariationPct !== undefined) document.getElementById('expectedVar').textContent = (data.expectedVariationPct > 0 ? '+' : '') + data.expectedVariationPct + '%';
                    else document.getElementById('expectedVar').textContent = '-';
                } catch (e) { console.error(e); alert('Error loading prediction: ' + e.message); }
            }

            document.addEventListener('DOMContentLoaded', () => {
                // wire events
                document.getElementById('productSelect').addEventListener('change', fetchAndRenderPrediction);
                document.getElementById('horizon').addEventListener('change', fetchAndRenderPrediction);
                document.getElementById('btnGeneratePDF').addEventListener('click', () => alert('PDF generation feature coming soon!'));
                document.getElementById('btnSaveHistory').addEventListener('click', () => {
                    if (!currentPredictionData) return alert('No prediction data to save');
                    alert('Prediction saved to history!');
                });

                initLinks();
                loadProducts();
            });

            // init sidebar links using tienda id
            function initLinks() {
                const tid = tienda;
                if (!tid) return;
                document.getElementById('linkDashboard').href = `/admin/tiendas/${tid}/dashboard`;
                document.getElementById('linkInventario').href = `/admin/tiendas/${tid}/inventario`;
                document.getElementById('linkProveedores').href = `/admin/tiendas/${tid}/proveedores`;
                document.getElementById('linkDeudas').href = `/admin/tiendas/${tid}/deudas`;
                document.getElementById('linkPuntoVenta').href = `/admin/tiendas/${tid}/puntoventa`;
                document.getElementById('linkInforme').href = `/admin/tiendas/${tid}/informe`;
                document.getElementById('linkPrediccion').href = `/admin/tiendas/${tid}/prediccion`;
                document.getElementById('linkTendero').href = `/admin/tiendas/${tid}/tendero`;
                document.getElementById('linkTiendas').href = `/admin/tiendas`;
            }

        })();
    </script>

</body>

</html>