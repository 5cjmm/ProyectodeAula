<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ShopMaster - Dashboard</title>
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<style>

    /* Sidebar collapse behavior */
    #sidebar.collapsed {
      width: 5rem;
      padding-left: 0.75rem;
      padding-right: 0.75rem;
    }

    #sidebar.collapsed .sidebar-text {
      display: none;
    }

    #sidebar.collapsed img {
      height: 2.5rem;
      width: auto;
    }

    /* Tooltip position */
    .tooltip {
      left: 3.5rem;
      top: 50%;
      transform: translateY(-50%);
      white-space: nowrap;
      z-index: 10;
      pointer-events: none;
    }
</style>
<body class="bg-gray-50">
  <div class="flex min-h-screen">

    <!-- SIDEBAR -->
    <aside id="sidebar"
      class="transition-all duration-300 w-64 bg-white border-r border-gray-200 p-6 flex flex-col">
      <div id="logoContainer" class="flex flex-col items-center mb-10 cursor-pointer">
        <div class="p-4 rounded-xl shadow-sm border border-gray-100 hover:scale-105 transition">
          <img th:src="@{/images/logo.png}" alt="ShopMaster"
            class="h-28 w-auto object-contain drop-shadow-md">
        </div>
      </div>

      <input type="hidden" id="tiendaId" th:value="${tiendaId}">
      <input type="hidden" id="rolUsuario" th:value="${session.rolUsuario}">
      <nav id="navLinks" class="space-y-2">
        <a id="linkDashboard" class="flex items-center gap-3 px-3 py-2 bg-cyan-50 text-cyan-700 rounded-lg"
          data-tooltip="Dashboard">
          <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M3 12l2-2m0 0l7-7 7 7m-9 2v8m4-8v8m4 0h-4m-4 0H5m14 0a2 2 0 002-2V9a2 2 0 00-.586-1.414l-7-7a2 2 0 00-2.828 0l-7 7A2 2 0 003 9v9a2 2 0 002 2h14z" />
          </svg>
          <span class="sidebar-text">Dashboard</span>
        </a>

        <a id="linkInventario"
          class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg"
          data-tooltip="Inventario">
          <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7h18M3 12h18M3 17h18" />
          </svg>
          <span class="sidebar-text">Inventario</span>
        </a>

        <a id="linkProveedores"
          class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg"
          data-tooltip="Proveedores">
          <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M8 7a4 4 0 118 0m-4 4a4 4 0 014 4v1H8v-1a4 4 0 014-4z" />
          </svg>
          <span class="sidebar-text">Proveedores</span>
        </a>

        <a id="linkDeudas"
          class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg"
          data-tooltip="Deudas">
          <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 8c-1.657 0-3 .895-3 2v2c0 1.105 1.343 2 3 2s3-.895 3-2v-2c0-1.105-1.343-2-3-2zm0 8v2m0-10V6" />
          </svg>
          <span class="sidebar-text">Deudas</span>
        </a>

        <a id="linkPuntoVenta"
          class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg"
          data-tooltip="Punto de Venta">
          <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M3 3h18v18H3zM7 7h10v4H7zM7 15h10v2H7z" />
          </svg>
          <span class="sidebar-text">Punto de Venta</span>
        </a>

        <a id="linkInforme"
          class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg"
          data-tooltip="Informe de Ventas">
          <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M9 17v-6m4 6V9m4 8V5M5 3v18h14V3H5z" />
          </svg>
          <span class="sidebar-text">Informe</span>
        </a>

        <a id="linkPrediccion"
          class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg"
          data-tooltip="PredicciÃ³n">
          <svg class="w-6 h-6 shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path d="M3 3h14v2H3V3zm0 4h10v2H3V7zm0 4h6v2H3v-2z" />
          </svg>
          <span class="sidebar-text">PredicciÃ³n</span>
        </a>
        <a id="linkTendero"
          class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg"
          data-tooltip="GestiÃ³n de Tenderos">
          <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M5.121 17.804A4 4 0 018 16h8a4 4 0 012.879 1.804M12 14a4 4 0 100-8 4 4 0 000 8z" />
          </svg>
          <span class="sidebar-text">GestiÃ³n de Tenderos</span>
        </a>

        <!-- Tiendas -->
        <a id="linkTiendas"
          class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg"
          data-tooltip="Tiendas">
          <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
          </svg>
          <span class="sidebar-text">Tiendas</span>
        </a>
      </nav>
    </aside>

    <!-- MAIN -->
<div class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200 shadow-sm">
                <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                    <h1 class="text-xl font-semibold text-gray-800">Dashboard</h1>

                    <div class="relative">
                        <button id="userMenuButton"
                            class="flex items-center gap-3 px-3 py-2 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition">

                            <!-- âšª SVG Avatar con cÃ­rculo gris -->
                            <div
                                class="w-9 h-9 rounded-full border-2 border-gray-300 bg-gray-100 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="26" height="26">
                                    <path fill="none"
                                        d="M8.007 24.93A4.996 4.996 0 0 1 13 20h6a4.996 4.996 0 0 1 4.993 4.93a11.94 11.94 0 0 1-15.986 0M20.5 12.5A4.5 4.5 0 1 1 16 8a4.5 4.5 0 0 1 4.5 4.5" />
                                    <path fill="#0891b2"
                                        d="M26.749 24.93A13.99 13.99 0 1 0 2 16a13.9 13.9 0 0 0 3.251 8.93l-.02.017c.07.084.15.156.222.239c.09.103.187.2.28.3q.418.457.87.87q.14.124.28.242q.48.415.99.782c.044.03.084.069.128.1v-.012a13.9 13.9 0 0 0 16 0v.012c.044-.031.083-.07.128-.1q.51-.368.99-.782q.14-.119.28-.242q.451-.413.87-.87c.093-.1.189-.197.28-.3c.071-.083.152-.155.222-.24ZM16 8a4.5 4.5 0 1 1-4.5 4.5A4.5 4.5 0 0 1 16 8M8.007 24.93A4.996 4.996 0 0 1 13 20h6a4.996 4.996 0 0 1 4.993 4.93a11.94 11.94 0 0 1-15.986 0" />
                                </svg>
                            </div>

                            <span id="userGreeting" th:text="'Hola, ' + ${usuario.username}"
                                class="text-sm font-medium text-gray-700">
                                Hola, Usuario
                            </span>

                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                                <path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="1.5" d="m6 9l6 6l6-6" />
                            </svg>
                        </button>

                        <!-- ðŸ”½ MenÃº desplegable -->
                        <div id="userDropdown"
                            class="absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg opacity-0 translate-y-[-10px] scale-95 pointer-events-none transition-all duration-200 z-50">

                            <div class="px-4 py-3 border-b border-gray-100">
                                <p class="text-sm text-gray-700">Rol:</p>
                                <p id="userRole"
                                    th:text="${#lists.contains(usuario.roles, 'ROLE_ADMIN') ? 'Administrador' : 'Tendero'}"
                                    class="font-semibold text-gray-900">
                                    Administrador
                                </p>
                            </div>

                            <a id="linkPerfil"
                                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition">
                                Perfil
                            </a>

                            <button id="logoutBtn"
                                class="w-full text-left flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                                    <g fill="none">
                                        <path fill="#f00034"
                                            d="M12 3a1 1 0 0 1 .117 1.993L12 5H7a1 1 0 0 0-.993.883L6 6v12a1 1 0 0 0 .883.993L7 19h4.5a1 1 0 0 1 .117 1.993L11.5 21H7a3 3 0 0 1-2.995-2.824L4 18V6a3 3 0 0 1 2.824-2.995L7 3zm5.707 5.464l2.828 2.829a1 1 0 0 1 0 1.414l-2.828 2.829a1 1 0 1 1-1.414-1.415L17.414 13H12a1 1 0 1 1 0-2h5.414l-1.121-1.121a1 1 0 0 1 1.414-1.415" />
                                    </g>
                                </svg>
                                Cerrar sesiÃ³n
                            </button>
                        </div>
                    </div>
                </div>
            </header>



            <!-- Dashboard Content -->
            <main class="flex-1 p-6 space-y-6">
                

                <!-- Metrics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">Ventas Totales (COP)</h3>
                            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" />
                            </svg>
                        </div>
                        <div class="text-2xl font-bold" id="ventasTotales" th:text="${ventasTotalesFormatted}">$12,345
                        </div>
                        <div class="flex items-center gap-1 text-xs mt-1">
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">Productos en Stock</h3>
                            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" />
                            </svg>
                        </div>
                        <div class="text-2xl font-bold" id="productosEnStock" th:text="${productosEnStock}">1,234</div>
                        <div class="flex items-center gap-1 text-xs mt-1">
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">Ventas de Hoy</h3>
                            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" />
                            </svg>
                        </div>
                        <div class="text-2xl font-bold" id="ventasHoy" th:text="${ventasHoy}">89</div>
                        <div class="flex items-center gap-1 text-xs mt-1">
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">Deudas Activas</h3>
                            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                            </svg>
                        </div>
                        <div class="text-2xl font-bold" id="deudasActivas" th:text="${deudasActivas}">456</div>
                        <div class="flex items-center gap-1 text-xs mt-1">

                        </div>
                    </div>
                </div>

                <!-- Charts and Tables Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Sales Chart -->
                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-semibold mb-4">Ventas Mensuales</h3>
                        <div class="h-64">
                            <canvas id="ventasMensualesChart" height="220"></canvas>
                        </div>
                    </div>

                    <!-- Inventory Table -->
                    <div class="bg-white p-6 rounded-lg border border-red-200">
                        <h3 class="text-lg font-semibold mb-4">Inventario Bajo</h3>
                        <div class="space-y-3" id="bajosContainer"
                            th:attr="data-page=${bajosPage.number},data-total-pages=${bajosPage.totalPages},data-total-elements=${bajosPage.totalElements}">
                            <div th:if="${bajosPage == null or #lists.isEmpty(bajosPage.content)}"
                                class="text-gray-500">No hay productos con stock bajo.</div>
                            <div th:each="p : ${bajosPage.content}"
                                class="flex items-center justify-between py-2 border-b border-gray-100 js-bajo-item">
                                <span class="font-medium" th:text="${p.nombre}">Producto</span>
                                <span class="text-red-500 font-semibold" th:text="${p.cantidad + ' unidades'}">0
                                    unidades</span>
                            </div>

                            <!-- PaginaciÃ³n simple -->
                            <div class="flex items-center justify-between mt-3" id="bajosPagination">
                                <div class="text-sm text-gray-600">
                                    <span id="bajosTotalElements" th:text="${bajosPage.totalElements}">0</span>
                                    productos encontrados
                                </div>
                                <div class="flex items-center gap-2">
                                    <!-- Anterior (botÃ³n) -->
                                    <button id="bajosPrev" type="button"
                                        class="px-4 py-2 bg-amber-400 text-white font-medium rounded-lg shadow hover:brightness-95">Anterior</button>
                                    <!-- NÃºmero de pÃ¡gina central -->
                                    <div class="px-3 py-1 bg-gray-100 border rounded-full text-center mx-1">
                                        <span class="font-medium" id="bajosPageNumber"
                                            th:text="${bajosPage.number + 1}">1</span>
                                    </div>
                                    <!-- Siguiente (botÃ³n) -->
                                    <button id="bajosNext" type="button"
                                        class="px-4 py-2 bg-green-500 text-white font-medium rounded-lg shadow hover:brightness-95">Siguiente</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Deudas recientes -->
                <div class="bg-white p-6 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold mb-4">Deudas Recientes</h3>
                    <div class="space-y-4">
                        <div th:if="${#lists.isEmpty(deudasRecientes)}" class="text-gray-500">No hay deudas recientes.
                        </div>
                        <div th:each="d : ${deudasRecientes}"
                            class="flex items-center justify-between shadow-sm border-b border-gray-100">
                            <div>
                                <p class="font-medium"
                                    th:text="${d.nombreCliente != null ? d.nombreCliente : d.cedulaCliente}">Cliente</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold"
                                    th:text="${'$' + #numbers.formatDecimal(d.total, 1, 'COMMA', 0, 'POINT')}">$0</p>
                                <span th:text="${d.estado != null ? d.estado : 'NO PAGADA'}"
                                    th:class="${'inline-block px-2 py-1 text-xs rounded-full ' + (d.estado != null && d.estado.toUpperCase() == 'PAGADA' ? 'bg-green-100 text-green-800' : (d.estado != null && d.estado.toUpperCase() == 'PARCIAL' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'))}">
                                    Estado
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
  </div>

  <script th:inline="javascript">
    const logo = document.getElementById('logoContainer');
    const sidebar = document.getElementById('sidebar');

    if (localStorage.getItem('sidebar-collapsed') === 'true') {
    sidebar.classList.add('collapsed');
  }

    logo.addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
    const isCollapsed = sidebar.classList.contains('collapsed');
    localStorage.setItem('sidebar-collapsed', isCollapsed);
  });

    // Tooltip dinÃ¡mico (solo visible cuando estÃ¡ colapsado)
    document.querySelectorAll('[data-tooltip]').forEach(el => {
      const tooltip = document.createElement('div');
      tooltip.textContent = el.dataset.tooltip;
      tooltip.className = 'tooltip opacity-0 absolute bg-black text-white text-xs rounded px-2 py-1 transition duration-200';
      el.appendChild(tooltip);
      el.classList.add('relative');
      el.addEventListener('mouseenter', () => {
        if (sidebar.classList.contains('collapsed')) tooltip.classList.remove('opacity-0');
      });
      el.addEventListener('mouseleave', () => {
        tooltip.classList.add('opacity-0');
      });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const tiendaId = document.getElementById("tiendaId")?.value;
        const rol = document.getElementById("rolUsuario")?.value;

        // Formateador para enteros con separador de miles (usado solo para Productos en Stock)
        function fmtInt(n) {
            try { return new Intl.NumberFormat('es-CO', { maximumFractionDigits: 0 }).format(Number(n) || 0); }
            catch (e) { return '0'; }
        }

        if (!tiendaId) {
            console.error("âš ï¸ tiendaId no encontrado");
            return;
        }

        // ðŸ”— Enlaces dinÃ¡micos
        document.getElementById("linkDashboard").href = `/tiendas/${tiendaId}/dashboard`;
        document.getElementById("linkInventario").href = `/tiendas/${tiendaId}/inventario`;
        document.getElementById("linkProveedores").href = `/tiendas/${tiendaId}/proveedores`;
        document.getElementById("linkDeudas").href = `/tiendas/${tiendaId}/deudas`;
        document.getElementById("linkPuntoVenta").href = `/tiendas/${tiendaId}/puntoventa`;
        document.getElementById("linkInforme").href = `/tiendas/${tiendaId}/informe`;
        document.getElementById("linkPrediccion").href = `/tiendas/${tiendaId}/prediccion`;
        document.getElementById("linkTendero").href = `/tiendas/${tiendaId}/tendero`;
        document.getElementById("linkPerfil").href = `/tiendas/${tiendaId}/perfil`;
        document.getElementById("linkTiendas").href = `/tiendas`;

        // ðŸ§± Ocultar elementos segÃºn el rol
        if (rol === "ROLE_TENDERO") {
            const tenderoMenu = document.getElementById("linkTendero");
            const tiendasMenu = document.getElementById("linkTiendas");

            if (tenderoMenu) tenderoMenu.style.display = "none";
            if (tiendasMenu) tiendasMenu.style.display = "none";
        }



        // --- GrÃ¡fico: Ventas Mensuales ---
        let ventasChart;
        async function loadVentasMensuales() {
            try {
                const res = await fetch(`/api/ventas/tienda/${tiendaId}/mensuales?meses=12`);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();
                // Asegurar orden cronolÃ³gico por (aÃ±o, mes)
                // Orden cronolÃ³gico (aÃ±o, mes) y etiquetas numÃ©ricas (yyyy-MM)
                const ordered = Array.isArray(data) ? [...data].sort((a, b) => (a.year - b.year) || (a.month - b.month)) : [];
                const labels = ordered.map(d => d.label);
                const valores = ordered.map(d => d.total);
                const ctx = document.getElementById('ventasMensualesChart');
                if (!ctx) return;
                // destruir previo si existe
                if (ventasChart) { ventasChart.destroy(); }
                ventasChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Total ventas (COP)',
                            data: valores,
                            borderColor: 'rgb(14, 165, 233)',
                            backgroundColor: 'rgba(14, 165, 233, 0.35)'
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(ctx.parsed.y || 0)
                                }
                            }
                        },
                        scales: {
                            x: { ticks: { color: '#4b5563' } },
                            y: { ticks: { color: '#4b5563', callback: (v) => new Intl.NumberFormat('es-CO', { notation: 'compact' }).format(v) }, beginAtZero: true }
                        }
                    }
                });
            } catch (e) { console.error('Error cargando ventas mensuales:', e); }
        }

        // --- PaginaciÃ³n AJAX: Inventario Bajo ---
        const bajosContainer = document.getElementById('bajosContainer');
        const prevBtn = document.getElementById('bajosPrev');
        const nextBtn = document.getElementById('bajosNext');
        const pageNumberEl = document.getElementById('bajosPageNumber');
        const totalElementsEl = document.getElementById('bajosTotalElements');

        const button = document.getElementById("userMenuButton");
        const dropdown = document.getElementById("userDropdown");
        const logoutBtn = document.getElementById("logoutBtn");

        // Mostrar/ocultar con animaciÃ³n
        button.addEventListener("click", (e) => {
            e.stopPropagation();
            const isVisible = dropdown.classList.contains("opacity-100");
            dropdown.classList.toggle("opacity-100", !isVisible);
            dropdown.classList.toggle("translate-y-0", !isVisible);
            dropdown.classList.toggle("scale-100", !isVisible);
            dropdown.classList.toggle("pointer-events-none", isVisible);
            dropdown.classList.toggle("opacity-0", isVisible);
            dropdown.classList.toggle("translate-y-[-10px]", isVisible);
            dropdown.classList.toggle("scale-95", isVisible);
        });

        // Cerrar al hacer clic fuera
        document.addEventListener("click", (e) => {
            if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                dropdown.classList.add("opacity-0", "translate-y-[-10px]", "scale-95", "pointer-events-none");
                dropdown.classList.remove("opacity-100", "translate-y-0", "scale-100");
            }
        });

        // AcciÃ³n de cerrar sesiÃ³n
        logoutBtn.addEventListener("click", () => {
            if (confirm("Â¿Deseas cerrar sesiÃ³n?")) {
                window.location.href = "/logout";
            }
        });

        let bajosState = {
            page: parseInt(bajosContainer.getAttribute('data-page') || '0', 10),
            totalPages: parseInt(bajosContainer.getAttribute('data-total-pages') || '1', 10),
            totalElements: parseInt(bajosContainer.getAttribute('data-total-elements') || '0', 10)
        };

        function setButtonsState() {
            if (bajosState.page <= 0) {
                prevBtn.classList.add('opacity-60', 'cursor-not-allowed');
            } else {
                prevBtn.classList.remove('opacity-60', 'cursor-not-allowed');
            }
            if (bajosState.page >= bajosState.totalPages - 1) {
                nextBtn.classList.add('opacity-60', 'cursor-not-allowed');
            } else {
                nextBtn.classList.remove('opacity-60', 'cursor-not-allowed');
            }
        }

        async function loadBajos(page) {
            try {
                const res = await fetch(`/tiendas/${tiendaId}/dashboard/bajos?bajosPage=${page}`, { headers: { 'Accept': 'application/json' } });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();

                // Render lista
                const listNodes = bajosContainer.querySelectorAll('[data-item="bajo-item"], .js-bajo-item');
                listNodes.forEach(n => n.remove());

                if (!data.content || data.content.length === 0) {
                    // Mostrar mensaje vacÃ­o si no hay elementos
                    if (!bajosContainer.querySelector('#bajosEmpty')) {
                        const empty = document.createElement('div');
                        empty.id = 'bajosEmpty';
                        empty.className = 'text-gray-500';
                        empty.textContent = 'No hay productos con stock bajo.';
                        bajosContainer.prepend(empty);
                    }
                } else {
                    const existingEmpty = bajosContainer.querySelector('#bajosEmpty');
                    if (existingEmpty) existingEmpty.remove();
                    data.content.forEach(p => {
                        const row = document.createElement('div');
                        row.setAttribute('data-item', 'bajo-item');
                        row.className = 'flex items-center justify-between py-2 border-b border-gray-100';
                        row.innerHTML = `<span class="font-medium">${p.nombre}</span>
                                         <span class="text-red-500 font-semibold">${p.cantidad} unidades</span>`;
                        // Insert before pagination block
                        const pagination = document.getElementById('bajosPagination');
                        bajosContainer.insertBefore(row, pagination);
                    });
                }

                // Actualizar estado y UI
                bajosState.page = data.page;
                bajosState.totalPages = data.totalPages;
                bajosState.totalElements = data.totalElements;
                pageNumberEl.textContent = (bajosState.page + 1).toString();
                totalElementsEl.textContent = bajosState.totalElements.toString();
                setButtonsState();

                // Asegurar que siempre se vean 5 filas
                padBajosRows();
            } catch (e) {
                console.error('Error cargando inventario bajo:', e);
            }
        }

        function padBajosRows() {
            const pagination = document.getElementById('bajosPagination');
            const currentRows = bajosContainer.querySelectorAll('[data-item="bajo-item"], .js-bajo-item');
            const toAdd = Math.max(0, 5 - currentRows.length);
            for (let i = 0; i < toAdd; i++) {
                const filler = document.createElement('div');
                filler.className = 'flex items-center justify-between py-2 border-b border-gray-100 text-gray-300';
                filler.setAttribute('data-item', 'bajo-item');
                filler.innerHTML = '<span class="font-medium">â€”</span><span class="font-semibold">â€”</span>';
                bajosContainer.insertBefore(filler, pagination);
            }
        }

        // Inicializaciones
        // Aplicar formateo sÃ³lo a Productos en Stock (no tocar Ventas Totales)
        try {
            const stockEl = document.getElementById('productosEnStock');
            if (stockEl) {
                const raw = (stockEl.textContent || '').replace(/[^0-9\-\.]/g, '');
                const num = Number(raw) || 0;
                stockEl.textContent = fmtInt(num);
            }
        } catch (e) { /* no bloquear la inicializaciÃ³n si falla el formateo */ }

        loadVentasMensuales();
        setButtonsState();
        // Padding inicial para mantener 5 filas visibles
        padBajosRows();
        prevBtn.addEventListener('click', () => {
            if (bajosState.page > 0) loadBajos(bajosState.page - 1);
        });
        nextBtn.addEventListener('click', () => {
            if (bajosState.page < bajosState.totalPages - 1) loadBajos(bajosState.page + 1);
        });
    });

    // linkPrediccion now uses the standardized admin path: /admin/tiendas/{tiendaId}/prediccion
    const menuToggle = document.getElementById("menu-toggle");
    const menu = document.getElementById("menu");

    if (menuToggle && menu) {
        menuToggle.addEventListener("click", () => {
            menu.classList.toggle("hidden");
        });
    }
  </script>

</body>
</html>
