<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Proveedores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
</head>
<body class="bg-blue-100 dark:bg-blue-900 min-h-screen flex flex-col items-center p-6">
    
    <nav class="w-full bg-blue-300 p-4 flex justify-between items-center shadow-md">
        <img src="https://shopmaster.in/uploads/logo/logo_66593bf8604a3.svg" alt="Logo" class="w-25 h-10 rounded-full">
        <div class="text-gray-900 dark:text-white text-2xl font-bold">Registro de Proveedores</div>
        <div class="relative">
            <button id="menu-toggle" class="text-gray-900 dark:text-white px-4 py-2">
                <img src="https://www.shutterstock.com/image-vector/menu-icon-trendy-flat-style-600nw-432264136.jpg" alt="Men√∫" class="w-8 h-8">
            </button>
            <div id="menu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-blue-800 shadow-lg rounded-lg overflow-hidden">
                <a th:href="@{/Inicio}" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Inicio</a>
                <a id="linkDashboard" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Dashboard</a>
                <a id="linkInforme" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Informe de Venta</a>
                <a id="linkTendero" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Gestion de Tenderos</a>
                <a id="linkInventario" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Inventario</a>
                <a id="linkProveedores" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Proveedores</a>
                <a id="linkDeudas" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Gestionar Deudas</a>
                <a id="linkPuntoVenta" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Punto de Venta</a>
                <a href="/logout" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Cerrar sesi√≥n</a>
            </div>

        </div>
    </nav>
  
    <div class="w-full max-w-4xl bg-white dark:bg-blue-800 shadow-lg rounded-2xl p-6">
        
        <input type="hidden" id="tiendaId" th:value="${tiendaId}">

        <form class="grid grid-cols-2 gap-4 mb-6" id="formProveedor">
            <input type="text" id="nombre" name="nombre" placeholder="Nombre" class="w-full p-2 mb-3 border rounded-md" required>
            <input type="text" id="nit" name="nit" placeholder="Nit" class="w-full p-2 mb-3 border rounded-md" required>
            <input type="text" id="direccion" name="direccion" placeholder="Direcci√≥n" class="w-full p-2 mb-3 border rounded-md" required>
            <input type="text" id="telefono" name="telefono" placeholder="Tel√©fono" class="w-full p-2 mb-3 border rounded-md" required>
    
            <div class="col-span-2 flex justify-center gap-4 mt-4">
                <button type="submit" class="bg-blue-400 text-white px-6 py-2 rounded-lg font-bold shadow-md hover:bg-blue-500">
                    Guardar
                </button>
            </div>          
        </form>

        <input type="text" class="w-full p-2 mb-3 border rounded-md" id="buscar" placeholder="Buscar proveedor..." onkeyup="filtrarPorPrimeraLetra()">
        <div th:if="${SuccessMessage != null}" class="bg-green-500 text-white p-2 rounded-md">
            <p th:text="${SuccessMessage}"></p>
        </div>
        
        <div class="overflow-x-auto bg-blue-200 dark:bg-blue-700 p-4 rounded-xl shadow-md">
            <table id="tablaProveedor" class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-blue-400 dark:bg-blue-600 text-white">
                        <th class="p-3">Nombre</th>
                        <th class="p-3">Nit</th>
                        <th class="p-3">Direcci√≥n</th>
                        <th class="p-3">Tel√©fono</th>
                        <th class="p-3">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaProveedores">
                </tbody>
            </table>
        </div>
        <div id="alertBox" class="hidden p-3 rounded-lg mt-3 text-white font-bold"></div>
    
        <div class="pagination flex justify-center items-center gap-4 mt-4">
  <button id="btnAnterior" class="bg-yellow-500 text-white px-3 py-1 rounded-lg font-bold hover:bg-yellow-600">Anterior</button>
  <span id="paginaActual">1</span>
  <button id="btnSiguiente" class="bg-green-500 text-white px-3 py-1 rounded-lg font-bold hover:bg-green-600">Siguiente</button>
</div>

        
    </div> 

    
    <script>
        const menuToggle = document.getElementById("menu-toggle");
        const menu = document.getElementById("menu");
        
        menuToggle.addEventListener("click", () => {
            menu.classList.toggle("hidden");
        });
    </script>

<script>
    function filtrarPorPrimeraLetra() {
            let input = document.getElementById("buscar").value.toLowerCase();
            let tabla = document.getElementById("tablaProveedor");
            let filas = tabla.getElementsByTagName("tr");

            for (let i = 1; i < filas.length; i++) {
                let nombreProveedor = filas[i].getElementsByTagName("td")[0]; 

                if (nombreProveedor) {
                    let texto = nombreProveedor.textContent.toLowerCase();
                    filas[i].style.display = texto.startsWith(input) ? "" : "none";
                }
            }
        }
</script>

<script>
const tiendaId = document.getElementById("tiendaId").value;

let pagina = 0;           // üìå Spring Data empieza en 0
const tamanoPagina = 5;   // üìå Proveedores por p√°gina
let totalPaginas = 0;

// üöÄ Mostrar alertas bonitas
function mostrarAlerta(mensaje, tipo = "error") {
  const alertBox = document.getElementById("alertBox");
  alertBox.textContent = mensaje;

  if (tipo === "error") {
    alertBox.className = "p-3 rounded-lg mt-3 bg-red-500 text-white font-bold";
  } else if (tipo === "success") {
    alertBox.className = "p-3 rounded-lg mt-3 bg-green-500 text-white font-bold";
  } else if (tipo === "warning") {
    alertBox.className = "p-3 rounded-lg mt-3 bg-yellow-500 text-white font-bold";
  }

  alertBox.classList.remove("hidden");
  setTimeout(() => alertBox.classList.add("hidden"), 3000);
}

// üöÄ Cargar proveedores desde backend con paginaci√≥n
async function cargarProveedores() {
  const res = await fetch(`/api/proveedores/tienda/${tiendaId}?page=${pagina}&size=${tamanoPagina}`);
  if (!res.ok) {
    mostrarAlerta("‚ùå Error al cargar proveedores", "error");
    return;
  }

  const data = await res.json();
  const proveedores = data.content || data.proveedores || [];
  totalPaginas = data.totalPages || 1;

  const tbody = document.getElementById("tablaProveedores");
  tbody.innerHTML = "";

  proveedores.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="p-3 dark:text-white">${p.nombre}</td>
      <td class="p-3 dark:text-white">${p.nit}</td>
      <td class="p-3 dark:text-white">${p.direccion}</td>
      <td class="p-3 dark:text-white">${p.telefono}</td>
      <td class="p-3">
        <button class="btn-edit bg-yellow-500 text-white px-3 py-1 rounded-lg font-bold hover:bg-yellow-600"
                data-id="${p.id}" data-nombre="${p.nombre}" data-nit="${p.nit}"
                data-telefono="${p.telefono}" data-direccion="${p.direccion}">
          Editar
        </button>
        <button class="btn-delete bg-red-500 text-white px-3 py-1 rounded-lg font-bold hover:bg-red-600"
                data-id="${p.id}">
          Eliminar
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("paginaActual").textContent = pagina + 1;
}

// üöÄ Botones de paginaci√≥n
document.getElementById("btnAnterior").addEventListener("click", () => {
  if (pagina > 0) {
    pagina--;
    cargarProveedores();
  }
});

document.getElementById("btnSiguiente").addEventListener("click", () => {
  if (pagina + 1 < totalPaginas) {
    pagina++;
    cargarProveedores();
  }
});

// üöÄ Delegaci√≥n de eventos para Editar / Eliminar
document.getElementById("tablaProveedores").addEventListener("click", async (e) => {
  const btn = e.target.closest("button");
  if (!btn) return;

  if (btn.classList.contains("btn-edit")) {
    const form = document.getElementById("formProveedor");
    form.dataset.id = btn.dataset.id;
    form.nombre.value = btn.dataset.nombre;
    form.nit.value = btn.dataset.nit;
    form.telefono.value = btn.dataset.telefono;
    form.direccion.value = btn.dataset.direccion;
    return;
  }

  if (btn.classList.contains("btn-delete")) {
    if (!confirm("¬øSeguro de eliminar este proveedor?")) return;

    const id = btn.dataset.id;
    const resp = await fetch(`/api/proveedores/eliminar/${id}?tiendaId=${encodeURIComponent(tiendaId)}`, {
      method: "DELETE"
    });

    if (!resp.ok) {
      const msg = await resp.text();
      mostrarAlerta("‚ùå Error al eliminar: " + msg, "error");
      return;
    }
    mostrarAlerta("üóëÔ∏è Proveedor eliminado correctamente", "success");
    cargarProveedores();
  }
});

// üöÄ Crear / Actualizar proveedor con validaciones
document.getElementById("formProveedor").addEventListener("submit", async function (e) {
  e.preventDefault();

  const proveedor = {
    nombre: this.nombre.value.trim(),
    nit: this.nit.value.trim(),
    telefono: this.telefono.value.trim(),
    direccion: this.direccion.value.trim(),
    tiendaId: tiendaId
  };

  const isEdit = !!this.dataset.id;
  const url = isEdit 
      ? `/api/proveedores/actualizar/${this.dataset.id}`
      : `/api/proveedores/crear`;
  const method = isEdit ? "PUT" : "POST";

  const resp = await fetch(url, {
    method,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(proveedor)
  });

  if (!resp.ok) {
    const msg = await resp.text();

    // üö® Validaciones personalizadas
    if (msg.includes("nit")) {
      mostrarAlerta("‚ö†Ô∏è El NIT ya est√° registrado", "warning");
    } else if (msg.includes("telefono")) {
      mostrarAlerta("‚ö†Ô∏è El tel√©fono ya est√° registrado", "warning");
    } else {
      mostrarAlerta("‚ùå Error al guardar: " + msg, "error");
    }
    return;
  }

  this.reset();
  delete this.dataset.id;
  mostrarAlerta(isEdit ? "‚úÖ Proveedor actualizado" : "‚úÖ Proveedor creado", "success");
  cargarProveedores();
});

// üöÄ Init
cargarProveedores();
document.getElementById("linkDashboard").href = `/admin/tiendas/${tiendaId}/dashboard`;
document.getElementById("linkInventario").href = `/admin/tiendas/${tiendaId}/inventario`;
document.getElementById("linkProveedores").href = `/admin/tiendas/${tiendaId}/proveedores`;
document.getElementById("linkDeudas").href = `/admin/tiendas/${tiendaId}/deudas`;
document.getElementById("linkPuntoVenta").href = `/admin/tiendas/${tiendaId}/puntoventa`;
document.getElementById("linkInforme").href = `/admin/tiendas/${tiendaId}/informe`;
document.getElementById("linkTendero").href = `/admin/tiendas/${tiendaId}/tendero`;
</script>



<script>
        function cerrarModal() {
    document.getElementById('formulario-modal').classList.add('hidden');
    document.getElementById('modal-background').classList.add('hidden');
  }

  function llenarFormularioDesdeBoton(button) {
    document.getElementById('edit-id').value = button.dataset.id;
    document.getElementById('edit-nombre').value = button.dataset.nombre;
    document.getElementById('edit-ruc').value = button.dataset.ruc;
    document.getElementById('edit-direccion').value = button.dataset.direccion;
    document.getElementById('edit-telefono').value = button.dataset.telefono;
    document.getElementById('formulario-modal').classList.remove('hidden');
    document.getElementById("modal-background").classList.remove('hidden');
  }
    </script>
</body>
</html>
