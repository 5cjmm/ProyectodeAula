<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Inventario - ShopMaster</title>
    <link rel="icon" href="/img/logo-tc.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    
</head>
<body class="bg-blue-100 dark:bg-blue-900 min-h-screen flex flex-col items-center p-6">
    
    <nav class="w-full bg-blue-300 p-4 flex justify-between items-center shadow-md">
        <img src="https://shopmaster.in/uploads/logo/logo_66593bf8604a3.svg" alt="Logo" class="w-25 h-10 rounded-full">
        <div class="text-gray-900 dark:text-white text-2xl font-bold">Inventario</div>
        <div class="relative">
            <button id="menu-toggle" class="text-gray-900 dark:text-white px-4 py-2">
                <img src="https://www.shutterstock.com/image-vector/menu-icon-trendy-flat-style-600nw-432264136.jpg" alt="Men√∫" class="w-8 h-8">
            </button>
            <div sec:authorize="hasAuthority('ROLE_TENDERO')" id="menu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-blue-800 shadow-lg rounded-lg overflow-hidden">
                <a th:href="@{/Inicio}" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Inicio</a>
                <a th:href="@{/tendero/PuntoVenta}" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Punto de Venta</a>
                <a th:href="@{/admin/Inventario}" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Inventario</a>
                <a th:href="@{/deudas}" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Gestionar Deudas</a>
                <a href="/logout" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Cerrar sesi√≥n</a>
            </div>

            <div sec:authorize="hasAuthority('ROLE_ADMIN')" id="menu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-blue-800 shadow-lg rounded-lg overflow-hidden">
                <a id="linkDashboard" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Dashboard</a>
                <a id="linkInforme" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Informe de Venta</a>
                <a id="linkInventario" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Inventario</a>
                <a id="linkTendero" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Gestion de Tenderos</a>
                <a id="linkProveedores" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Proveedores</a>
                <a id="linkDeudas" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Gestionar Deudas</a>
                <a id="linkPuntoVenta" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Punto de Venta</a>
                <a href="/logout" class="block px-4 py-2 text-gray-900 dark:text-white hover:bg-blue-300 dark:hover:bg-blue-600">Cerrar sesi√≥n</a>
            </div>
        </div>
    </nav>

    <div class="w-full max-w-6xl bg-white dark:bg-blue-800 shadow-lg rounded-2xl p-6 flex gap-6">
        
        <div class="w-1/3 p-4 bg-gray-100 dark:bg-blue-700 rounded-xl shadow-md">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Agregar Producto</h2>
            <input type="hidden" id="tiendaId" th:value="${tiendaId}">
            
            <!-- Fixed form structure and field names -->
            <form id="formProducto">
                <label class="block text-gray-900 dark:text-white">C√≥digo:</label>
                <input type="text" name="codigo" class="w-full p-2 mb-3 border rounded-md" required />

                <label class="block text-gray-900 dark:text-white">Nombre:</label>
                <input type="text" name="nombre" class="w-full p-2 mb-3 border rounded-md" required />

                <label class="block text-gray-900 dark:text-white">Cantidad:</label>
                <input type="number" name="cantidad" class="w-full p-2 mb-3 border rounded-md" required />

                <label class="block text-gray-900 dark:text-white">Precio:</label>
                <input type="number" name="precio" class="w-full p-2 mb-3 border rounded-md" step="0.01" required />

                <label class="block text-gray-900 dark:text-white">Proveedor:</label>
                <select class="w-full p-2 mb-3 border rounded-md h-32" multiple name="proveedorId" id="proveedorId"></select>
        
                <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-green-600 w-full">
                    Guardar
                </button>
            </form> 
        </div>
        
        <div class="w-2/3">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Productos Registrados</h2>
            <div class="overflow-x-auto bg-gray-100 dark:bg-blue-700 p-4 rounded-xl shadow-md">
                <!-- Added search functionality -->
                <input type="text" class="w-full p-2 mb-4 border rounded-md" id="buscar" placeholder="Buscar producto..." onkeyup="buscarProductos()">
                
                <!-- Alert container for messages -->
                <div id="alertBox" class="hidden"></div>
                
                <table id="tablaProductos" class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-blue-500 text-white">
                            <th class="p-3">C√≥digo</th>
                            <th class="p-3">Nombre</th>
                            <th class="p-3">Cantidad</th>
                            <th class="p-3">Precio (COP)</th>
                            <th class="p-3">Proveedor</th>
                            <th class="p-3">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic content loaded via AJAX -->
                    </tbody>
                </table>

                <div class="pagination flex justify-center items-center gap-4 mt-4">
                    <button class="bg-yellow-500 text-white px-3 py-1 rounded-lg font-bold shadow-md hover:bg-yellow-600" onclick="cambiarPagina(-1)">Anterior</button>
                    <span id="paginaActual">1</span>
                    <button class="bg-green-500 text-white px-3 py-1 rounded-lg font-bold shadow-md hover:bg-green-600" onclick="cambiarPagina(1)">Siguiente</button>
                </div>
            </div>
        </div>  
    </div>

<script>
const tiendaId = document.getElementById("tiendaId").value;

let pagina = 0;           
const tamanoPagina = 5;   
let totalPaginas = 0;
let busquedaActual = "";

function mostrarAlerta(mensaje, tipo = "error") {
  const alertBox = document.getElementById("alertBox");
  alertBox.textContent = mensaje;

  if (tipo === "error") {
    alertBox.className = "p-3 rounded-lg mt-3 bg-red-500 text-white font-bold text-center";
  } else if (tipo === "success") {
    alertBox.className = "p-3 rounded-lg mt-3 bg-green-500 text-white font-bold text-center";
  } else if (tipo === "warning") {
    alertBox.className = "p-3 rounded-lg mt-3 bg-yellow-500 text-white font-bold text-center";
  }

  alertBox.classList.remove("hidden");
  setTimeout(() => alertBox.classList.add("hidden"), 3000);
}

async function cargarProveedoresSelect(selectId = "proveedorId") {
  const select = document.getElementById(selectId);
  if (!select) { 
    console.warn(`No existe #${selectId}`); 
    return; 
  }

  try {
    console.log("[v0] Loading providers for tienda:", tiendaId);
    const res = await fetch(`/api/proveedores/tienda/${tiendaId}`);
    if (!res.ok) { 
      console.log("[v0] Provider request failed:", res.status, res.statusText);
      mostrarAlerta("‚ùå No se pudieron cargar proveedores", "error"); 
      return; 
    }

    const data = await res.json();
    console.log("[v0] Provider response:", data);
    
    const proveedores = data.content || data || [];
    
    select.innerHTML = "";
    if (proveedores.length === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No hay proveedores disponibles";
      select.appendChild(opt);
      mostrarAlerta("‚ö†Ô∏è No hay proveedores registrados para esta tienda", "warning");
      return;
    }
    
    proveedores.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = `${p.nombre} (${p.nit})`;
      select.appendChild(opt);
    });
    
    console.log("[v0] Loaded", proveedores.length, "providers");
  } catch (error) {
    console.log("[v0] Error loading providers:", error);
    mostrarAlerta("‚ùå Error al cargar proveedores", "error");
  }
}

async function cargarProductos() {
  try {
    console.log("[v0] Loading products for tienda:", tiendaId, "page:", pagina);
    const res = await fetch(`/api/productos/tienda/${tiendaId}?page=${pagina}&size=${tamanoPagina}`);
    if (!res.ok) {
      console.log("[v0] Product request failed:", res.status, res.statusText);
      mostrarAlerta("‚ùå Error al cargar productos", "error");
      return;
    }

    const data = await res.json();
    console.log("[v0] Product response:", data);
    const productos = data.content || [];
    totalPaginas = data.totalPages || 1;

    const tbody = document.getElementById("tablaProductos").querySelector("tbody");
    tbody.innerHTML = "";

    productos.forEach(p => {
      let provs = p.proveedores ? p.proveedores.map(pr => pr.nombre).join(", ") : "";
      const tr = document.createElement("tr");
      tr.className = "border-b text-gray-900 dark:text-white";
      tr.innerHTML = `
        <td class="p-3">${p.codigo}</td>
        <td class="p-3">${p.nombre}</td>
        <td class="p-3">${p.cantidad}</td>
        <td class="p-3">$${p.precio}</td>
        <td class="p-3">${provs}</td>
        <td class="p-3">
          <button class="btn-edit bg-yellow-500 text-white px-3 py-1 rounded-lg font-bold hover:bg-yellow-600 mr-2"
                  data-id="${p.id}" data-codigo="${p.codigo}" data-nombre="${p.nombre}"
                  data-cantidad="${p.cantidad}" data-precio="${p.precio}">
            Editar
          </button>
          <button class="btn-delete bg-red-500 text-white px-3 py-1 rounded-lg font-bold hover:bg-red-600"
                  data-id="${p.id}">
            Eliminar
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("paginaActual").textContent = pagina + 1;
  } catch (error) {
    console.log("[v0] Error loading products:", error);
    mostrarAlerta("‚ùå Error al cargar productos", "error");
  }
}

function cambiarPagina(direccion) {
  if (direccion === -1 && pagina > 0) {
    pagina--;
    cargarProductos();
  }
  if (direccion === 1 && pagina + 1 < totalPaginas) {
    pagina++;
    cargarProductos();
  }
}

document.getElementById("tablaProductos").addEventListener("click", async (e) => {
  const btn = e.target.closest("button");
  if (!btn) return;

  if (btn.classList.contains("btn-edit")) {
    const form = document.getElementById("formProducto");
    form.dataset.id = btn.dataset.id;
    form.codigo.value = btn.dataset.codigo;
    form.nombre.value = btn.dataset.nombre;
    form.cantidad.value = btn.dataset.cantidad;
    form.precio.value = btn.dataset.precio;
    return;
  }

  if (btn.classList.contains("btn-delete")) {
    if (!confirm("¬øEliminar este producto?")) return;
    const id = btn.dataset.id;

    try {
      const resp = await fetch(`/api/productos/${id}?tiendaId=${tiendaId}`, { method: "DELETE" });
      if (!resp.ok) {
        const errorMsg = await resp.text();
        mostrarAlerta("‚ùå Error al eliminar: " + errorMsg, "error");
        return;
      }
      mostrarAlerta("üóëÔ∏è Producto eliminado correctamente", "success");
      cargarProductos();
    } catch (error) {
      mostrarAlerta("‚ùå Error al eliminar producto", "error");
    }
  }
});

document.getElementById("formProducto").addEventListener("submit", async function (e) {
  e.preventDefault();

  const selectedProveedores = Array.from(document.getElementById("proveedorId").selectedOptions).map(o => o.value);
  
  const producto = {
    codigo: this.codigo.value.trim(),
    nombre: this.nombre.value.trim(),
    cantidad: parseInt(this.cantidad.value),
    precio: parseFloat(this.precio.value),
    proveedorIdStrs: selectedProveedores,
    tiendaId: tiendaId
  };

  const isEdit = !!this.dataset.id;
  const url = isEdit 
      ? `/api/productos/${this.dataset.id}`
      : `/api/productos`;
  const method = isEdit ? "PUT" : "POST";

  try {
    const resp = await fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(producto)
    });

    if (!resp.ok) {
      const msg = await resp.text();
      if (msg.includes("c√≥digo")) {
        mostrarAlerta("‚ö†Ô∏è El c√≥digo ya est√° registrado", "warning");
      } else if (msg.includes("nombre")) {
        mostrarAlerta("‚ö†Ô∏è El nombre ya est√° registrado", "warning");
      } else {
        mostrarAlerta("‚ùå Error al guardar: " + msg, "error");
      }
      return;
    }

    this.reset();
    delete this.dataset.id;
    mostrarAlerta(isEdit ? "‚úÖ Producto actualizado" : "‚úÖ Producto creado", "success");
    cargarProductos();
  } catch (error) {
    mostrarAlerta("‚ùå Error de conexi√≥n", "error");
  }
});

function buscarProductos() {
  const input = document.getElementById("buscar").value.toLowerCase();
  const filas = document.querySelectorAll("#tablaProductos tbody tr");
  
  filas.forEach(fila => {
    const nombre = fila.cells[1].textContent.toLowerCase();
    const codigo = fila.cells[0].textContent.toLowerCase();
    
    if (nombre.includes(input) || codigo.includes(input)) {
      fila.style.display = "";
    } else {
      fila.style.display = "none";
    }
  });
}

document.addEventListener("DOMContentLoaded", function() {
  cargarProveedoresSelect();
  cargarProductos();
  
 document.getElementById("linkDashboard").href = `/admin/tiendas/${tiendaId}/dashboard`;
document.getElementById("linkInventario").href = `/admin/tiendas/${tiendaId}/inventario`;
document.getElementById("linkProveedores").href = `/admin/tiendas/${tiendaId}/proveedores`;
document.getElementById("linkDeudas").href = `/admin/tiendas/${tiendaId}/deudas`;
document.getElementById("linkPuntoVenta").href = `/admin/tiendas/${tiendaId}/puntoventa`;
document.getElementById("linkInforme").href = `/admin/tiendas/${tiendaId}/informe`;
document.getElementById("linkTendero").href = `/admin/tiendas/${tiendaId}/tendero`;

});

// Menu toggle functionality
const menuToggle = document.getElementById("menu-toggle");
const menu = document.getElementById("menu");

if (menuToggle && menu) {
  menuToggle.addEventListener("click", () => {
    menu.classList.toggle("hidden");
  });
}
</script>

</body>
</html>
