<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ShopMaster - Gesti√≥n de Tenderos</title>
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<style>

    /* Sidebar collapse behavior */
    #sidebar.collapsed {
      width: 5rem;
      padding-left: 0.75rem;
      padding-right: 0.75rem;
    }

    #sidebar.collapsed .sidebar-text {
      display: none;
    }

    #sidebar.collapsed img {
      height: 2.5rem;
      width: auto;
    }

    /* Tooltip position */
    .tooltip {
      left: 3.5rem;
      top: 50%;
      transform: translateY(-50%);
      white-space: nowrap;
      z-index: 10;
      pointer-events: none;
    }
</style>
<body class="bg-gray-50">

  <div class="flex min-h-screen">
    <!-- Sidebar (mant√©n tu sidebar real; aqu√≠ est√° reducido para demo) -->
    <aside id="sidebar"
      class="transition-all duration-300 w-64 bg-white border-r border-gray-200 p-6 flex flex-col">
      <div id="logoContainer" class="flex flex-col items-center mb-10 cursor-pointer">
        <div class="p-4 rounded-xl shadow-sm border border-gray-100 hover:scale-105 transition">
          <img th:src="@{/images/logo.png}" alt="ShopMaster"
            class="h-28 w-auto object-contain drop-shadow-md">
        </div>
      </div>

      <input type="hidden" id="tiendaId" th:value="${tiendaId}">
      <input type="hidden" id="rolUsuario" th:value="${session.rolUsuario}">
      <nav id="navLinks" class="space-y-2">
        <a id="linkDashboard" class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg"
          data-tooltip="Dashboard">
          <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M3 12l2-2m0 0l7-7 7 7m-9 2v8m4-8v8m4 0h-4m-4 0H5m14 0a2 2 0 002-2V9a2 2 0 00-.586-1.414l-7-7a2 2 0 00-2.828 0l-7 7A2 2 0 003 9v9a2 2 0 002 2h14z" />
          </svg>
          <span class="sidebar-text">Dashboard</span>
        </a>

        <a id="linkInventario"
          class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg"
          data-tooltip="Inventario">
          <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7h18M3 12h18M3 17h18" />
          </svg>
          <span class="sidebar-text">Inventario</span>
        </a>

        <a id="linkProveedores"
          class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg"
          data-tooltip="Proveedores">
          <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M8 7a4 4 0 118 0m-4 4a4 4 0 014 4v1H8v-1a4 4 0 014-4z" />
          </svg>
          <span class="sidebar-text">Proveedores</span>
        </a>

        <a id="linkDeudas"
          class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg"
          data-tooltip="Deudas">
          <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 8c-1.657 0-3 .895-3 2v2c0 1.105 1.343 2 3 2s3-.895 3-2v-2c0-1.105-1.343-2-3-2zm0 8v2m0-10V6" />
          </svg>
          <span class="sidebar-text">Deudas</span>
        </a>

        <a id="linkPuntoVenta"
          class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg"
          data-tooltip="Punto de Venta">
          <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M3 3h18v18H3zM7 7h10v4H7zM7 15h10v2H7z" />
          </svg>
          <span class="sidebar-text">Punto de Venta</span>
        </a>

        <a id="linkInforme"
          class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg"
          data-tooltip="Informe de Ventas">
          <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M9 17v-6m4 6V9m4 8V5M5 3v18h14V3H5z" />
          </svg>
          <span class="sidebar-text">Informe</span>
        </a>

        <a id="linkPrediccion"
          class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg"
          data-tooltip="Predicci√≥n">
          <svg class="w-6 h-6 shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path d="M3 3h14v2H3V3zm0 4h10v2H3V7zm0 4h6v2H3v-2z" />
          </svg>
          <span class="sidebar-text">Predicci√≥n</span>
        </a>
        <a id="linkTendero"
          class="flex items-center gap-3 px-3 py-2 bg-cyan-50 text-cyan-700 rounded-lg"
          data-tooltip="Gesti√≥n de Tenderos">
          <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M5.121 17.804A4 4 0 018 16h8a4 4 0 012.879 1.804M12 14a4 4 0 100-8 4 4 0 000 8z" />
          </svg>
          <span class="sidebar-text">Gesti√≥n de Tenderos</span>
        </a>

        <!-- Tiendas -->
        <a id="linkTiendas"
          class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-lg"
          data-tooltip="Tiendas">
          <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
          </svg>
          <span class="sidebar-text">Tiendas</span>
        </a>
      </nav>
    </aside>

    <div class="flex-1 flex flex-col">
      <!-- Header -->
      <header class="bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
          <h1 class="text-xl font-semibold text-gray-800">Gestion de Tenderos</h1>

          <div class="relative">
            <button id="userMenuButton"
              class="flex items-center gap-3 px-3 py-2 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition">

              <!-- ‚ö™ SVG Avatar con c√≠rculo gris -->
              <div class="w-9 h-9 rounded-full border-2 border-gray-300 bg-gray-100 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="26" height="26">
                  <path fill="none"
                    d="M8.007 24.93A4.996 4.996 0 0 1 13 20h6a4.996 4.996 0 0 1 4.993 4.93a11.94 11.94 0 0 1-15.986 0M20.5 12.5A4.5 4.5 0 1 1 16 8a4.5 4.5 0 0 1 4.5 4.5" />
                  <path fill="#0891b2"
                    d="M26.749 24.93A13.99 13.99 0 1 0 2 16a13.9 13.9 0 0 0 3.251 8.93l-.02.017c.07.084.15.156.222.239c.09.103.187.2.28.3q.418.457.87.87q.14.124.28.242q.48.415.99.782c.044.03.084.069.128.1v-.012a13.9 13.9 0 0 0 16 0v.012c.044-.031.083-.07.128-.1q.51-.368.99-.782q.14-.119.28-.242q.451-.413.87-.87c.093-.1.189-.197.28-.3c.071-.083.152-.155.222-.24ZM16 8a4.5 4.5 0 1 1-4.5 4.5A4.5 4.5 0 0 1 16 8M8.007 24.93A4.996 4.996 0 0 1 13 20h6a4.996 4.996 0 0 1 4.993 4.93a11.94 11.94 0 0 1-15.986 0" />
                </svg>
              </div>

              <span id="userGreeting" th:text="'Hola, ' + ${usuario.username}"
                class="text-sm font-medium text-gray-700">
                Hola, Usuario
              </span>

              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                <path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="m6 9l6 6l6-6" />
              </svg>
            </button>

            <!-- üîΩ Men√∫ desplegable -->
            <div id="userDropdown"
              class="absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg opacity-0 translate-y-[-10px] scale-95 pointer-events-none transition-all duration-200 z-50">

              <div class="px-4 py-3 border-b border-gray-100">
                <p class="text-sm text-gray-700">Rol:</p>
                <p id="userRole" th:text="${#lists.contains(usuario.roles, 'ROLE_ADMIN') ? 'Administrador' : 'Tendero'}"
                  class="font-semibold text-gray-900">
                  Administrador
                </p>
              </div>

              <a id="linkPerfil" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition">
                Perfil
              </a>

              <button id="logoutBtn"
                class="w-full text-left flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                  <g fill="none">
                    <path fill="#f00034"
                      d="M12 3a1 1 0 0 1 .117 1.993L12 5H7a1 1 0 0 0-.993.883L6 6v12a1 1 0 0 0 .883.993L7 19h4.5a1 1 0 0 1 .117 1.993L11.5 21H7a3 3 0 0 1-2.995-2.824L4 18V6a3 3 0 0 1 2.824-2.995L7 3zm5.707 5.464l2.828 2.829a1 1 0 0 1 0 1.414l-2.828 2.829a1 1 0 1 1-1.414-1.415L17.414 13H12a1 1 0 1 1 0-2h5.414l-1.121-1.121a1 1 0 0 1 1.414-1.415" />
                  </g>
                </svg>
                Cerrar sesi√≥n
              </button>
            </div>
          </div>
        </div>
      </header>

      <main class="w-full max-w-none px-8 py-8">
        <div class="max-w-[1200px] mx-auto space-y-6">

          <!-- Formulario Crear / Editar -->
          <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
            <h2 class="text-lg font-semibold mb-4">Registrar / Editar Tendero</h2>

            <form id="formTendero" class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Nombre</label>
                <input id="username" name="username" type="text" required
                  class="mt-1 block w-full rounded-md border-gray-200 shadow-sm" />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700">Email</label>
                <input id="email" name="email" type="email" required
                  class="mt-1 block w-full rounded-md border-gray-200 shadow-sm" />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700">Contrase√±a</label>
                <input id="password" name="password" type="password" placeholder="M√≠nimo 6 caracteres"
                  class="mt-1 block w-full rounded-md border-gray-200 shadow-sm" />
                <p class="text-xs text-gray-400 mt-1">Si editas y dejas en blanco, la contrase√±a no cambiar√°.</p>
              </div>

              <div class="md:col-span-2 flex gap-3 justify-end mt-2">
                <button type="reset" id="btnReset" class="flex items-center justify-center gap-2 bg-gradient-to-r from-blue-500 to-blue-600 
                        hover:from-blue-600 hover:to-blue-700 text-white font-semibold 
                        px-6 py-3 rounded-lg transition-all duration-200 transform 
                        hover:scale-[1.02] hover:shadow-lg focus:outline-none focus:ring-2 
                        focus:ring-blue-400 focus:ring-offset-2">
                  <!-- SVG Limpiar -->
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-5 w-5" fill="#ffffff">
                    <path fill-rule="evenodd"
                      d="M8.339 13.884A4.48 4.48 0 0 1 11 17.979v.222c0 1.207.48 2.365 1.333 3.218l.374.374l1.707 1.707H.001l.43-1.311l1.835-5.604a4.48 4.48 0 0 1 3.489-3.019L11.35.508l2.298.985zM12 15.5h7V13h-7zm9 4h-7V17h7zm2 4h-7V21h7z"
                      clip-rule="evenodd" />
                  </svg>
                  Limpiar
                </button>

                <button type="submit" class="flex items-center gap-2 bg-gradient-to-r from-blue-500 to-blue-600 
                          hover:from-blue-600 hover:to-blue-700 text-white font-semibold 
                          px-6 py-3 rounded-lg transition-all duration-200 transform 
                          hover:scale-[1.02] hover:shadow-lg focus:outline-none focus:ring-2 
                          focus:ring-blue-400 focus:ring-offset-2">
                  <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6"></path>
                  </svg>
                  <span>Guardar Tendero</span>
                </button>
              </div>
            </form>
          </div>

          <!-- Tabla y buscador -->
          <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold">Tenderos de la tienda</h3>
              <div class="flex items-center gap-3">
                <input id="buscar" type="text" placeholder="Buscar por nombre o username"
                  class="px-3 py-2 border rounded-md" />
                <button id="btnRefresh" class="flex items-center gap-2 bg-gradient-to-r from-blue-500 to-blue-600 
                          hover:from-blue-600 hover:to-blue-700 text-white font-semibold 
                          px-6 py-3 rounded-lg transition-all duration-200 transform 
                          hover:scale-[1.02] hover:shadow-lg focus:outline-none focus:ring-2 
                          focus:ring-blue-400 focus:ring-offset-2">

                  <!-- SVG de refrescar -->
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 21 21" class="h-5 w-5" fill="none"
                    stroke="#ffffff" stroke-linecap="round" stroke-linejoin="round">
                    <g fill="none" fill-rule="evenodd">
                      <path d="M3.578 6.487A8 8 0 1 1 2.5 10.5" />
                      <path d="M7.5 6.5h-4v-4" />
                    </g>
                  </svg>

                  Refrescar
                </button>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table id="tablaTenderos" class="min-w-full bg-blue-50 text-blue-900 rounded-lg overflow-hidden">
                <thead class="bg-blue-500 text-white">
                  <tr class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4">
                    <th class="text-white font-semibold px-4 py-3 text-left">Nombre</th>
                    <th class="text-white font-semibold px-4 py-3 text-left">Email</th>
                    <th class="text-white font-semibold px-4 py-3 text-left">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- contenido por JS -->
                </tbody>
              </table>
            </div>

            <div id="emptyTenderos" class="text-center py-8 text-gray-500 hidden">
              No hay tenderos registrados para esta tienda.
            </div>
          </div>

        </div>
      </main>
    </div>
  </div>

  <script>
    (function () {
      // helpers
      function showNotification(msg, type = 'info') {
        const colors = { success: 'bg-green-600', error: 'bg-red-600', warning: 'bg-yellow-500', info: 'bg-blue-600' };
        const d = document.createElement('div');
        d.className = `fixed top-20 right-5 px-4 py-3 rounded-lg shadow-lg text-white font-semibold z-50 transition transform duration-300 ${colors[type] || colors.info}`;
        d.textContent = msg;
        document.body.appendChild(d);
        setTimeout(() => { d.style.opacity = 0; d.style.transform = 'translateY(-8px)'; setTimeout(() => d.remove(), 300); }, 3000);
      }

      // DOM
      const tiendaIdEl = document.getElementById('tiendaId');
      const tiendaId = tiendaIdEl ? tiendaIdEl.value : null;
      const tablaBody = document.querySelector('#tablaTenderos tbody');
      const emptyEl = document.getElementById('emptyTenderos');
      const buscarInput = document.getElementById('buscar');
      const btnRefresh = document.getElementById('btnRefresh');

      const form = document.getElementById('formTendero');
      const usernameEl = document.getElementById('username');
      const emailEl = document.getElementById('email');
      const passwordEl = document.getElementById('password');
      const btnReset = document.getElementById('btnReset');
      const btnSave = document.getElementById('btnSave');

      const button = document.getElementById("userMenuButton");
      const dropdown = document.getElementById("userDropdown");
      const logoutBtn = document.getElementById("logoutBtn");

      const logo = document.getElementById('logoContainer');
      const sidebar = document.getElementById('sidebar');

      if (localStorage.getItem('sidebar-collapsed') === 'true') {
      sidebar.classList.add('collapsed');
    }

      logo.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      const isCollapsed = sidebar.classList.contains('collapsed');
      localStorage.setItem('sidebar-collapsed', isCollapsed);
    });

      // Tooltip din√°mico (solo visible cuando est√° colapsado)
      document.querySelectorAll('[data-tooltip]').forEach(el => {
        const tooltip = document.createElement('div');
        tooltip.textContent = el.dataset.tooltip;
        tooltip.className = 'tooltip opacity-0 absolute bg-black text-white text-xs rounded px-2 py-1 transition duration-200';
        el.appendChild(tooltip);
        el.classList.add('relative');
        el.addEventListener('mouseenter', () => {
          if (sidebar.classList.contains('collapsed')) tooltip.classList.remove('opacity-0');
        });
        el.addEventListener('mouseleave', () => {
          tooltip.classList.add('opacity-0');
        });
      });

      // Mostrar/ocultar con animaci√≥n
      button.addEventListener("click", (e) => {
        e.stopPropagation();
        const isVisible = dropdown.classList.contains("opacity-100");
        dropdown.classList.toggle("opacity-100", !isVisible);
        dropdown.classList.toggle("translate-y-0", !isVisible);
        dropdown.classList.toggle("scale-100", !isVisible);
        dropdown.classList.toggle("pointer-events-none", isVisible);
        dropdown.classList.toggle("opacity-0", isVisible);
        dropdown.classList.toggle("translate-y-[-10px]", isVisible);
        dropdown.classList.toggle("scale-95", isVisible);
      });

      // Cerrar al hacer clic fuera
      document.addEventListener("click", (e) => {
        if (!dropdown.contains(e.target) && !button.contains(e.target)) {
          dropdown.classList.add("opacity-0", "translate-y-[-10px]", "scale-95", "pointer-events-none");
          dropdown.classList.remove("opacity-100", "translate-y-0", "scale-100");
        }
      });

      // Acci√≥n de cerrar sesi√≥n
      logoutBtn.addEventListener("click", () => {
        if (confirm("¬øDeseas cerrar sesi√≥n?")) {
          window.location.href = "/logout";
        }
      });

      let tenderos = []; // listado en memoria
      let editId = null;  // si estamos editando

      if (!tiendaId) {
        console.error('tiendaId no encontrado en DOM (#tiendaId)');
        showNotification('tiendaId no encontrado. Algunas funciones no estar√°n disponibles', 'warning');
      }

      // cargar tenderos
      async function cargarTenderos() {
        try {
          tablaBody.innerHTML = '';
          if (!tiendaId) return;
          const res = await fetch(`/api/tenderos/tienda/${tiendaId}`);
          if (!res.ok) {
            const txt = await res.text().catch(() => 'Error al obtener tenderos');
            showNotification(txt, 'error');
            return;
          }
          tenderos = await res.json();
          if (!Array.isArray(tenderos) || tenderos.length === 0) {
            emptyEl.classList.remove('hidden');
            return;
          } else emptyEl.classList.add('hidden');

          tenderos.forEach(t => {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-blue-100 hover:bg-blue-100 transition-colors';
            tr.innerHTML = `
            <td class="px-6 py-3">${escapeHtml(t.username || '')}</td>
            <td class="px-6 py-3">${escapeHtml(t.email || '')}</td>
            <td class="px-6 py-3 gap-2">
              <button class="btn-edit bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600" 
                  data-id="${t.id}" title="Editar tendero">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="#ffffff">
                      <path fill-rule="evenodd" d="M5 20h14a1 1 0 0 1 0 2H5a1 1 0 0 1 0-2m-1-5L14 5l3 3L7 18H4zM15 4l2-2l3 3l-2.001 2.001z"/>
                    </svg>
              </button>
              <button class="btn-delete bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600" 
                  data-id="${t.id}" title="Eliminar tendero">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="#ffffff">
                      <path d="M5 20a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V8h2V6h-4V4a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v2H3v2h2zM9 4h6v2H9zM8 8h9v12H7V8z"/>
                      <path d="M9 10h2v8H9zm4 0h2v8h-2z"/>
                    </svg>
              </button>
            </td>`;
            tablaBody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
          showNotification('Error al cargar tenderos', 'error');
        }
      }

      // escape b√°sico para evitar inyecci√≥n en innerHTML
      function escapeHtml(str) {
        return String(str)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }

      // buscar (filtrado en cliente)
      buscarInput.addEventListener('input', () => {
        const q = buscarInput.value.trim().toLowerCase();
        Array.from(tablaBody.querySelectorAll('tr')).forEach(row => {
          const username = row.cells[0].textContent.toLowerCase();
          const nombre = row.cells[1].textContent.toLowerCase();
          row.style.display = (username.includes(q) || nombre.includes(q)) ? '' : 'none';
        });
      });

      btnRefresh.addEventListener('click', () => cargarTenderos());

      // manejar clicks en la tabla
      tablaBody.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.dataset.id;
        if (btn.classList.contains('btn-edit')) {
          const t = tenderos.find(x => x.id === id);
          if (!t) return showNotification('Tendero no encontrado', 'error');
          // cargar al formulario
          editId = t.id;
          usernameEl.value = t.username || '';
          emailEl.value = t.email || '';
          passwordEl.value = ''; // no mostrar contrase√±a
          showNotification('Editando tendero', 'info');
          return;
        }
        if (btn.classList.contains('btn-delete')) {
          if (!confirm('¬øEliminar este tendero?')) return;
          try {
            const resp = await fetch(`/api/tenderos/eliminar/${id}`, { method: 'DELETE' });
            const txt = await resp.text().catch(() => '');
            if (!resp.ok) {
              showNotification(txt || 'Error al eliminar', 'error');
              return;
            }
            showNotification('üóëÔ∏è Tendero eliminado', 'success');
            cargarTenderos();
          } catch (err) {
            console.error(err);
            showNotification('Error al eliminar tendero', 'error');
          }
        }
      });

      // crear / actualizar tendero
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const payload = {
          username: usernameEl.value.trim(),
          email: emailEl.value.trim(),
          // include password only when provided (backend should ignore blank on update)
          password: passwordEl.value ? passwordEl.value : undefined,
        };

        // validation minimal
        if (!payload.username || !payload.email) {
          return showNotification('Username y email son obligatorios', 'warning');
        }

        try {
          let url, method;
          if (editId) {
            url = `/api/tenderos/actualizar/${editId}`;
            method = 'PUT';
            // If password is undefined, remove the field to avoid sending "password":undefined in JSON
            if (payload.password === undefined) delete payload.password;
          } else {
            url = `/api/tenderos/crear?tiendaId=${encodeURIComponent(tiendaId)}`;
            method = 'POST';
          }

          const resp = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const txt = await resp.text().catch(() => '');

          if (!resp.ok) {
            showNotification(txt || 'Error al guardar tendero', 'error');
            return;
          }

          showNotification(editId ? 'Tendero actualizado' : 'Tendero creado', 'success');
          form.reset();
          editId = null;
          cargarTenderos();
        } catch (err) {
          console.error(err);
          showNotification('Error de conexi√≥n', 'error');
        }
      });

      // reset handler cancels edit mode
      btnReset.addEventListener('click', (e) => {
        editId = null;
      });

      // init links and load
      function initLinks() {
        const tid = tiendaId;
        if (!tid) return;
        document.getElementById("linkDashboard").href = `/tiendas/${tiendaId}/dashboard`;
        document.getElementById("linkInventario").href = `/tiendas/${tiendaId}/inventario`;
        document.getElementById("linkProveedores").href = `/tiendas/${tiendaId}/proveedores`;
        document.getElementById("linkDeudas").href = `/tiendas/${tiendaId}/deudas`;
        document.getElementById("linkPuntoVenta").href = `/tiendas/${tiendaId}/puntoventa`;
        document.getElementById("linkInforme").href = `/tiendas/${tiendaId}/informe`;
        document.getElementById("linkPrediccion").href = `/tiendas/${tiendaId}/prediccion`;
        document.getElementById("linkTendero").href = `/tiendas/${tiendaId}/tendero`;
        document.getElementById("linkPerfil").href = `/tiendas/${tiendaId}/perfil`;
        document.getElementById("linkTiendas").href = `/tiendas`;
      }

      document.addEventListener('DOMContentLoaded', () => {
        initLinks();
        cargarTenderos();
      });

    })();
  </script>

</body>

</html>